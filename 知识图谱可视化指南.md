# 知识图谱可视化板块讲解指南

本指南旨在帮助开发者理解 HealthRAG 系统中“知识图谱可视化”模块的实现原理、核心架构以及关键技术细节。

---

## 1. 整体架构

该模块采用了 **前后端分离** 的设计模式，结合了图数据库的高效查询与前端动效库的交互能力。

### 技术栈
- **后端**: Python (FastAPI), py2neo (连接 Neo4j)
- **前端**: React, TypeScript, vis-network (图渲染服务), Tailwind CSS, Framer Motion
- **数据库**: Neo4j (存储多维医疗实体与关系)

---

## 2. 核心逻辑实现

### 2.1 后端 API 实现 (backend/services/neo4j_service.py)

后端提供了三个核心接口来驱动图谱展示：

1.  **图谱概览 (`/api/neo4j/graph/overview`)**:
    - **功能**: 初始进入时加载。随机/按限额获取图谱中的部分实体。
    - **逻辑**: 通过 Cypher 语句 `MATCH (n) RETURN id(n), n... LIMIT 150` 并使用 `id(n)` 确保节点 ID 的唯一性。
    - **过滤**: 支持按节点标签（如“疾病”、“药品”）进行初步刷选。

2.  **关键词搜索 (`/api/neo4j/graph/search`)**:
    - **逻辑优化**: 采用了“中心辐射”搜索策略。
        - **第一阶段**: 搜索名称包含关键词的所有节点（不限类型）。
        - **第二阶段**: 获取这些中心节点的一级邻居。
        - **过滤增强**: 当用户选择了“节点类型”时，系统会过滤**邻居节点**，从而实现“搜索感冒并只看其相关症状”的精准需求。

3.  **详情获取 (`/api/neo4j/graph/node/{node_id}`)**:
    - **功能**: 返回特定实体的所有元数据属性。

### 2.2 前端可视化渲染 (frontend/src/components/KnowledgeGraphModal.tsx)

可视化核心基于 `vis-network` 库，并进行了深度定制。

1.  **数据转换**: 将后端返回的 ID、标签与属性，映射为可视化坐标、形状（dot）与颜色。
2.  **视觉逻辑**:
    - **颜色映射**: 预定义了常用医疗实体的颜色方案（蓝色代表疾病，红色代表症状等）。
    - **高亮逻辑**: 搜索命中项显示为橙色且尺寸更大。
    - **状态管理**: 使用 `vis-data` 管理 Dataset，确保数据更新时无需重绘整个画布，提升交互流畅度。

---

## 3. 核心功能亮点

### 3.1 智能邻居过滤
与传统的全局过滤不同，本模块通过改进后端 Cypher 查询，实现了基于关系的“相关性过滤”。例如，当你搜索“感冒”并勾选“症状”时，系统不会在搜索阶段排除感冒，而是过滤掉感冒相关的非症状邻居（如感冒药），从而展示精确的病理图谱。

### 3.2 节点标签对齐
系统在开发过程中克服了“前端预设”与“数据库实际标签”不匹配的问题。例如，将前端通用词“症状”映射为数据库存储标签“疾病症状”，确保了数据流的准确性。

---

## 4. 常见问题排查 (QA)

**Q: 为什么搜索特定词并选择类型后显示为空？**
A: 请确认数据库中是否存在对应类型的邻居关系。例如，如果感冒在数据库中没有关联任何“食物”条目，选择食物过滤将隐藏相关节点。同时也需检查节点类型名称是否与数据库标签（Labels）完全一致。

**Q: 节点标签文字看不清？**
A: 节点文字默认配置为深灰色 (`#1f2937`)，与白色画布背景形成高对比度。

**Q: 加载速度慢？**
A: 概览阶段限制了加载节点数为 150，搜索阶段限制为 100，避免了一次性加载上万节点导致的浏览器卡顿。

---

## 5. 开发建议
若需扩展标签，请在 `KnowledgeGraphModal.tsx` 的 `NODE_COLORS` 和 `nodeTypeOptions` 中同步更新，并确保名称与 Neo4j 数据库中的 `labels(n)` 结果一致。
